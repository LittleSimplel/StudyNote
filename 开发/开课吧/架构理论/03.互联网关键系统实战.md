### 1.互联网注册中心设计与实践

#### Zookeeper

- 定义

  Zookeeper是一个分布式的，开放源码的分布式应用程序**协调**服务，是Google的Chubby一个开源的实现，它是集群的管理者，监视着集群中各个节点的状态根据节点提交的反馈进行下一步合理操作。

- 功能

  - 文件系统

  - 通知机制

- 分布式程序协调服务

  - 节点选主
  - 配置管理
  - 粗粒度分布式锁
  - 服务注册
  - 服务发现

#### 注册中心产品比较

![注册中心对比](D:\study\github\StudyNote\开发\开课吧\架构理论\img\注册中心对比.jpg)

#### 注册中心是一个Ap模型还是CP？

- 注册中心本质

  **Query函数**

  - SI = f(ServiceName)
  - serviceName查询服务参数
  - si为对应服务可用的（Ip：port）

  **服务不一致影响**

  - 节点流量不均衡：当注册了10个冗余服务 ，而调用方由于网络等故障只发现到了9个服务，使用cp模型，会继续等待发现第10个服务。使用cp模型，会调用已发现的服务，使原本10个服务承载的流量打在9个服务上。

  **对数据一致性不高，最终一致性即可。**

- 多数据中心

  ![多机房数据中心](D:\study\github\StudyNote\开发\开课吧\架构理论\img\多机房数据中心.jpg)

  所以zookeeper不支持多数据中心

#### 服务规模容量连通性

- 服务规模 = F（服务注册时，服务订阅数）超过一定数量，Zookeeper将不堪重负（1000个服务）

  - 服务发布大量注册写请求
  - 毫秒级服务健康状态的写请求
  - 服务与注册中心海量长连接
  - zookeeper写单点，不能水平扩展

- 解决办法

  - 按业务功能垂直拆分zookeeper集群

    商品一个注册中心，交易一个注册中心。注册中心之间隔离

  - 缺陷：破环了服务连通性，业务之间的整合联通不可预知。

#### 持久化储存

- 不需要存储

  - 实时的健康的服务列表
  - ZAB协议对每个写请求在节点上保持写一个事务日志
  - 定期将内存数据镜像dump到磁盘，保持数据一致性和持久性，保证宕机数据可恢复
  - 调用方关注调用服务的实时地址列表和实时健康状态，调用方不关注调用服务的历史地址列表和历史健康状态

- 需要存储

  服务元数据信息

  - 服务的版本，分组，所在的机房，权重，鉴权策略信息，服务标签等元信息

#### 服务健康检查

![注册中心健康检查](D:\study\github\StudyNote\开发\开课吧\架构理论\img\注册中心健康检查.jpg)

#### 注册中心容灾考虑

注册中心不能因为自身的任何原因破坏服务之间本身的可连通性

- 服务调用链路需要弱依赖注册中心，必须仅在服务发布，机器上下线，服务扩容等必要时才依赖
- 客户端设计考虑容灾
  - 缓存数据机制：Zookeeper节点全干掉，应用服务是否正常工作
  - 原生zookeeper客户端并不具备

#### Zookeeper适用场景

**适用场景**

- 在粗粒度分布式锁,分布式选主,主备高可用切换等不需要高 TPS 支持的场景下有不可替代的作用。（这些需求往往多集中在大数据、离线任务等相关的业务领域,因为大数据领域,讲究分割数据集,并且大部分时间分任务多进程/线程并行处理这些数据集,但是总是有一些点上需要将这些任务和进程统一协办调,这时候就是ZooKeeper发挥巨大作用的用武之地）
- 分布式协调

**不适合场景**

- 大规模交易
- 大规模服务发现

#### 自研注册中心

### 2.分布式配置心中设计与实践