### 总体架构

> 人与人之间最大的差异是认知差异，认知决定一切
>
> 千变万化的世界，学会以不变应万变

#### 架构是什么

架构：对场景抽象得出的支撑骨架。

合适的架构需要从多方面考虑：业务，人员技术研发能力，业务复杂度，数据规模大小，时间成本，运维能力等。架构没有最好，只有最合适，最合适的架构都是场景平衡折中的结果。

场景驱动架构不断演进

#### 互联网架构演进

![image-20210410224007661](https://study-java-img.oss-cn-guangzhou.aliyuncs.com/img/image-20210410224007661.png)

##### 1. 单体架构

所有业务功能都放在一个服务里面。

业务流程：

<img src="https://study-java-img.oss-cn-guangzhou.aliyuncs.com/img/image-20210410224246043.png" alt="image-20210410224246043" style="zoom: 50%;" />

**单体架构的优点：**

- 易开发

- 易测试

- 易部署

- 易扩展（前提，扩展是无状态化的）

  扩展：

  <img src="https://study-java-img.oss-cn-guangzhou.aliyuncs.com/img/image-20210410224338843.png" alt="image-20210410224338843" style="zoom:50%;" />

**单体架构适应场景**

- 业务场景简单，功能不复杂，研发人员少
  - o2o
- 创业公司初期
- 性能要求极其苛刻

**单体架构的痛点：**

- 耦合

解决方案：**单体服务拆成多个服务（**架构哲学）

##### 2. 垂直分层架构

按业务拆分

<img src="https://study-java-img.oss-cn-guangzhou.aliyuncs.com/img/image-20210410224816908.png" alt="image-20210410224816908" style="zoom: 50%;" />

缺点：每个服务还是单体

##### 3. 水平分层架构

按功能拆分

**分层设计原则**

<img src="https://study-java-img.oss-cn-guangzhou.aliyuncs.com/img/image-20210410224951465.png" alt="image-20210410224951465" style="zoom:50%;" />

前后端分类，后端返回数据不带展示逻辑，展示逻辑放前端 （时间）

**网关层功能：**

- 请求鉴权(过滤)
  - 登录鉴权
- 数据完整性性检查（定长header）
  - 数据包括 定长header和变长Body（不论用什么协议）
- 协议转换(服务内部通信)
  - json->hashmap(string,object)
- 路由转发
  - 转发到不同业务逻辑层
- 服务治理
  - 限流，降级，熔断

**业务逻辑层：**

业务处理逻辑

**数据访问层：**

- CRUD
- ORM（映射）
- Sharding（分库分表）
- 屏蔽底层存储差异性
  - Mysql/MongoDB
  - Redis

**水平分层架构服务和协议：**

同步架构/异步架构（提升吞吐量）

<img src="https://study-java-img.oss-cn-guangzhou.aliyuncs.com/img/image-20210410225515934.png" alt="image-20210410225515934" style="zoom: 67%;" />

**异步架构**

异步本质：随机写变成顺序写

异步实现：加入消息队列

异步场景：

- 大量写  √
  - 金融交易（解决方案：支付完后，状态变为申请中，支付完成后，状态修改成已到账）
  - 社交（发朋友圈，解决方案：发布后，提示保存成功，信息保存在本地，并显示在最新动态上，如果发布失败，通过发信息的方式提醒用户，发送失败，请重新发布（长连接推送））
- 读  ×

**水平分层架构分层**

过多：

- 请求路径变长
- 平均响应延时变高
- 定位问题变得复杂化
- 运维成本增加

过少：

- 变为单体服务

缺点：

- 每层粒度过粗

##### 4. 微服务架构（垂直加水平拆分）

<img src="https://study-java-img.oss-cn-guangzhou.aliyuncs.com/img/image-20210410230502879.png" alt="image-20210410230502879" style="zoom: 50%;" />

目的：

- **快速迭代，持续交付**
- **降本增效（架构本质）**

适应场景：

- 需求层面
  - 需求变化快

- 性能层面
  - rt（变高）（高频交易不用微服务架构）
  - 吞吐量（水平扩展->变高）
- 数据一致性层面
  - 强一致性不用

完整微服务架构：

存在问题：

- 需要关注服务间的通信，迭代速度变慢。
- 基础组件升级困难，影响交付能力和交付速度。
- 多编程语言之间通信问题，业务每种语言一套基础设施成本大

业务与通信组件耦合在一起

##### 6. 服务网格架构：

将服务与服务治理分开